<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/css/dashboard.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <title>Dashboard</title>
</head>
<body>
  <div class="dashboard">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <a href="#collector" data-role="collector">Collector Dashboard</a>
      <a href="#hospital" data-role="hospital">Hospital Dashboard</a>
      <a href="#admin" data-role="admin">Admin Panel</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      
      <!-- Collector Dashboard -->
      <section id="collector" data-role="collector">
        <h2>Collector Dashboard</h2>
        <div class="card">
          <h3>Pending Waste Requests</h3>
          <div id="wasteRequests"></div>
          <button onclick="acceptRequest()">Accept Request</button>
          <div class="status">
            <button onclick="updateStatus('Collected')">Collected</button>
            <button onclick="updateStatus('In Transit')">In Transit</button>
            <button onclick="updateStatus('Disposed')">Disposed</button>
          </div>
        </div>
      </section>

      <!-- Hospital Dashboard -->
      <section id="hospital" data-role="hospital">
        <h2>Hospital Dashboard</h2>
        <div class="card">
          <h3>Report New Waste</h3>
          <form id="wasteForm">
            <label for="location">Location:</label>
            <input type="text" id="location" required>
      
            <label for="type">Type of Waste:</label>
            <input type="text" id="type" required>
      
            <label for="weight">Weight (kg):</label>
            <input type="number" id="weight" required>
      
            <button type="submit">Submit Waste</button>
          </form>
        </div>
        <div class="card">
          <h3>Reported Waste</h3>
          <p>Status: <span id="wasteStatus">Pending</span></p>
          <p>Live Tracking: <span id="trackingStatus">Not Available</span></p>
          <p>Disposal Confirmation: Pending</p>
          <div id="map" style="height: 300px;"></div>
        </div>
      </section>

      <!-- Admin Panel -->
      <section id="admin" data-role="admin">
        <h2>Admin Panel</h2>
        <div class="card">
          <h3>Manage Users</h3>
          <p>Total Hospitals: <span id="totalHospitals">0</span></p>
          <p>Total Collectors: <span id="totalCollectors">0</span></p>
        </div>
        <div class="card">
          <h3>Analytics</h3>
          <p>Waste Collected: <span id="wasteCollected">0kg</span></p>
          <p>Compliance Rate: <span id="complianceRate">0%</span></p>
        </div>
      </section>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let truckMarker;
    
    // Script for wasteform

    document.getElementById("wasteForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const token = localStorage.getItem("token");
  const location = document.getElementById("location").value;
  const type = document.getElementById("type").value;
  const weight = document.getElementById("weight").value;

  try {
    const res = await fetch("https://medical-waste-management.onrender.com/api/waste", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ location, type, weight })
    });

    const data = await res.json();

    if (!res.ok) {
      alert("Error placing request: " + data.message);
      return;
    }

    alert("Waste request submitted successfully!");
    document.getElementById("wasteForm").reset();
    document.getElementById("wasteStatus").innerText = "Submitted";
  } catch (error) {
    console.error("Error submitting waste:", error);
    alert("Something went wrong.");
  }
});


    // Setup the map
    const map = L.map('map').setView([40.7128, -74.0060], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    truckMarker = L.marker([40.7128, -74.0060]).addTo(map).bindPopup("Truck Location");

    function updateMap(lat, lon) {
      truckMarker.setLatLng([lat, lon]);
      map.setView([lat, lon], 12);
    }

    function acceptRequest() {
      alert('Request Accepted');
      document.getElementById('wasteStatus').innerText = 'Accepted';
      updateTrackingStatus();
    }

    function updateStatus(status) {
      alert('Status updated to ' + status);
      document.getElementById('wasteStatus').innerText = status;
    }

    async function fetchWasteRequests() {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/waste", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        const container = document.getElementById("wasteRequests");
        container.innerHTML = "";
        data.forEach(req => {
          const div = document.createElement("div");
          div.className = "waste-request";
          div.innerHTML = `
            <p>Location: ${req.location}</p>
            <p>Type: ${req.type}</p>
            <p>Quantity: ${req.weight}kg</p>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Error fetching waste requests:", error);
      }
    }

    async function fetchLiveTracking() {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/tracking/123456", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        if (data?.lat && data?.lon) {
          document.getElementById("trackingStatus").innerText = data.status || "En Route";
          updateMap(data.lat, data.lon);
        }
      } catch (error) {
        console.error("Error fetching live tracking:", error);
      }
    }

    function updateTrackingStatus() {
      fetchLiveTracking();
      setInterval(fetchLiveTracking, 5000);
    }

    async function fetchAdminAnalytics() {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/admin/analytics", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        document.getElementById("totalHospitals").innerText = data.totalHospitals;
        document.getElementById("totalCollectors").innerText = data.totalCollectors;
        document.getElementById("wasteCollected").innerText = `${data.wasteCollected}kg`;
        document.getElementById("complianceRate").innerText = `${data.complianceRate}%`;
      } catch (error) {
        console.error("Error fetching admin analytics:", error);
      }
    }

    async function setRoleBasedUI() {
      try {
        const token = sessionStorage.getItem("token");
        const response = await fetch("/api/auth", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        const role = data.user.role;
        console.log("Logged in as:", role);

        // Hide all role-based sections not matching the current user
        document.querySelectorAll("[data-role]").forEach(el => {
          if (el.getAttribute("data-role") !== role) {
            el.style.display = "none";
          }
        });

        // Fetch respective data
        if (role === "collector") fetchWasteRequests();
        if (role === "hospital") fetchLiveTracking();
        if (role === "admin") fetchAdminAnalytics();

      } catch (error) {
        console.error("Role-based UI error:", error);
        window.location.href = "login.html";
      }
    }

    window.addEventListener("load", setRoleBasedUI);
  </script>
</body>
</html>
